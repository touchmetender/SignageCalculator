<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Signage Calculator - Calculation</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f2f2f2; }
    .top-bar { display: flex; justify-content: space-between; margin-bottom: 20px; }
    table { width: 100%; background: white; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; border: 1px solid #ccc; }
    input, select { padding: 5px; }
    button { margin-top: 10px; padding: 5px 10px; }
  </style>
</head>
<body>

<div class="top-bar">
  <div id="user-info">Logged in as: </div>
  <button onclick="logout()">Logout</button>
</div>

<h2>Signage Calculator</h2>

<input type="text" id="reference" placeholder="Reference Number"><br><br>

<select id="materialSelect"></select>
<br><br>
<input type="number" id="length" placeholder="Length (m)">
<input type="number" id="width" placeholder="Width (m)">
<button onclick="addCalculation()">Add Material</button>

<table id="calculation-table">
  <thead>
    <tr>
      <th>Material</th>
      <th>Length</th>
      <th>Width</th>
      <th>Area (m²)</th>
      <th>Price per m²</th>
      <th>Total Price</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="calculation-body"></tbody>
</table>

<button onclick="saveCalculation()">Save Calculation</button>

<h3>Saved Calculations</h3>
<ul id="saved-list"></ul>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCXtiSnNBHs1NQXwL6vrK-U71veeMpIpXQ",
  authDomain: "signagematerialdatabaseapp.firebaseapp.com",
  databaseURL: "https://signagematerialdatabaseapp-default-rtdb.firebaseio.com",
  projectId: "signagematerialdatabaseapp",
  storageBucket: "signagematerialdatabaseapp.firebasestorage.app",
  messagingSenderId: "276886100857",
  appId: "1:276886100857:web:ec1b93f74995aa30e1ada8",
  measurementId: "G-R4EHYT0MW6"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

auth.onAuthStateChanged(user => {
  if (!user) {
    window.location.href = "login.html";
  } else {
    document.getElementById('user-info').innerText = "Logged in as: " + user.email;
    loadMaterials();
    loadSaved();
  }
});

function logout() {
  auth.signOut();
}

function loadMaterials() {
  let materials = JSON.parse(localStorage.getItem("materials")) || [];
  const select = document.getElementById('materialSelect');
  select.innerHTML = "";
  materials.forEach((mat, index) => {
    select.innerHTML += `<option value="${index}">${mat.code} - ${mat.name}</option>`;
  });
}

let calculations = [];

function addCalculation() {
  const materials = JSON.parse(localStorage.getItem("materials")) || [];
  const index = document.getElementById('materialSelect').value;
  const length = parseFloat(document.getElementById('length').value);
  const width = parseFloat(document.getElementById('width').value);
  const area = length * width;
  const pricePerUnit = parseFloat(materials[index].priceUnit);
  const totalPrice = area * pricePerUnit;

  calculations.push({
    material: materials[index].name,
    length: length,
    width: width,
    area: area,
    pricePerUnit: pricePerUnit,
    totalPrice: totalPrice
  });

  renderCalculations();
}

function renderCalculations() {
  const tbody = document.getElementById('calculation-body');
  tbody.innerHTML = "";
  calculations.forEach((calc, index) => {
    tbody.innerHTML += `
    <tr>
      <td>${calc.material}</td>
      <td>${calc.length}</td>
      <td>${calc.width}</td>
      <td>${calc.area.toFixed(2)}</td>
      <td>${calc.pricePerUnit}</td>
      <td>${calc.totalPrice.toFixed(2)}</td>
      <td><button onclick="deleteCalculation(${index})">Delete</button></td>
    </tr>`;
  });
}

function deleteCalculation(index) {
  calculations.splice(index, 1);
  renderCalculations();
}

function saveCalculation() {
  const ref = document.getElementById('reference').value.trim();
  if (!ref) { alert("Please enter a Reference Number!"); return; }
  let saved = JSON.parse(localStorage.getItem("savedCalcs")) || {};
  saved[ref] = calculations;
  localStorage.setItem("savedCalcs", JSON.stringify(saved));
  calculations = [];
  renderCalculations();
  loadSaved();
  document.getElementById('reference').value = "";
}

function loadSaved() {
  const saved = JSON.parse(localStorage.getItem("savedCalcs")) || {};
  const ul = document.getElementById('saved-list');
  ul.innerHTML = "";
  for (let ref in saved) {
    ul.innerHTML += `<li>${ref} <button onclick="loadThis('${ref}')">Load</button> <button onclick="deleteThis('${ref}')">Delete</button></li>`;
  }
}

function loadThis(ref) {
  const saved = JSON.parse(localStorage.getItem("savedCalcs")) || {};
  calculations = saved[ref];
  renderCalculations();
}

function deleteThis(ref) {
  let saved = JSON.parse(localStorage.getItem("savedCalcs")) || {};
  delete saved[ref];
  localStorage.setItem("savedCalcs", JSON.stringify(saved));
  loadSaved();
}
</script>

</body>
</html>
