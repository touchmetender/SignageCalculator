<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Signage Calculator</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    header {
      display: flex; justify-content: space-between; align-items: center;
      background: #4a90e2; color: white; padding: 10px 20px;
    }
    header h1 { margin: 0; font-size: 20px; }
    .header-actions { display: flex; gap: 10px; align-items: center; }
    button { padding: 5px 10px; }
    main { padding: 20px; }
    .section { margin-bottom: 30px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    select, input[type="number"] { width: 100%; padding: 4px; }
    .dark { background-color: #222; color: white; }
    .dark table { border-color: #555; }
    .dark th, .dark td { border-color: #555; }
  </style>
</head>
<body>
  <header>
    <h1>Signage Calculator</h1>
    <div class="header-actions">
      <button id="toggle-theme">Toggle Theme</button>
      <button id="logout">Logout</button>
    </div>
  </header>

  <main>
    <div class="section">
      <h2>Rectangular Layers</h2>
      <button onclick="addRectLayer()">+ Add Rectangular Layer</button>
      <table id="rect-table">
        <thead>
          <tr>
            <th>Width (m)</th><th>Height (m)</th><th>Depth (m)</th><th>Area</th>
            <th>Category</th><th>Material</th><th>Price</th><th>Cost</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section">
      <h2>Circular Layers</h2>
      <button onclick="addCircLayer()">+ Add Circular Layer</button>
      <table id="circ-table">
        <thead>
          <tr>
            <th>Diameter (m)</th><th>Area</th>
            <th>Category</th><th>Material</th><th>Price</th><th>Cost</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="section">
      <h2>Total Material Cost: <span id="total-cost">0</span></h2>
    </div>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDQ0B-vlsma4aapqICAnZNmu3IXEMxFrC4",
      authDomain: "signage-calculator.firebaseapp.com",
      databaseURL: "https://signage-calculator-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "signage-calculator",
      storageBucket: "signage-calculator.appspot.com",
      messagingSenderId: "468265337334",
      appId: "1:468265337334:web:2480a776fb301a4d7028b2"
    };
    firebase.initializeApp(firebaseConfig);

    let currentUser = null;
    let categories = {};
    const db = firebase.database();

    firebase.auth().onAuthStateChanged((user) => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        currentUser = user;
        loadCategories();
      }
    });

    // Load categories and materials
    function loadCategories() {
      db.ref('materials').once('value').then(snapshot => {
        categories = snapshot.val() || {};
      });
    }

    // Add Rectangular Row
    function addRectLayer() {
      const row = document.createElement("tr");

      row.innerHTML = `
        <td><input type="number" step="0.01" class="width" onchange="calcRect(this)"></td>
        <td><input type="number" step="0.01" class="height" onchange="calcRect(this)"></td>
        <td><input type="number" step="0.01" class="depth" onchange="calcRect(this)"></td>
        <td class="area">0</td>
        <td><select class="category" onchange="updateMaterialDropdown(this)"><option value="">--</option></select></td>
        <td><select class="material" onchange="calcRect(this)"><option value="">--</option></select></td>
        <td class="price">0</td>
        <td class="cost">0</td>
      `;

      document.querySelector("#rect-table tbody").appendChild(row);
      populateCategoryDropdown(row.querySelector(".category"));
    }

    // Add Circular Row
    function addCircLayer() {
      const row = document.createElement("tr");

      row.innerHTML = `
        <td><input type="number" step="0.01" class="diameter" onchange="calcCirc(this)"></td>
        <td class="area">0</td>
        <td><select class="category" onchange="updateMaterialDropdown(this)"><option value="">--</option></select></td>
        <td><select class="material" onchange="calcCirc(this)"><option value="">--</option></select></td>
        <td class="price">0</td>
        <td class="cost">0</td>
      `;

      document.querySelector("#circ-table tbody").appendChild(row);
      populateCategoryDropdown(row.querySelector(".category"));
    }

    function populateCategoryDropdown(selectEl) {
      selectEl.innerHTML = '<option value="">--</option>';
      for (let cat in categories) {
        const option = document.createElement("option");
        option.value = cat;
        option.textContent = cat;
        selectEl.appendChild(option);
      }
    }

    function updateMaterialDropdown(select) {
      const row = select.closest("tr");
      const materialSelect = row.querySelector(".material");
      const category = select.value;

      materialSelect.innerHTML = '<option value="">--</option>';
      if (categories[category]) {
        for (let key in categories[category]) {
          const mat = categories[category][key];
          const opt = document.createElement("option");
          opt.value = key;
          opt.textContent = mat.material_name;
          opt.dataset.price = parseFloat(mat.material_price || 0);
          materialSelect.appendChild(opt);
        }
      }
    }

    function calcRect(el) {
      const row = el.closest("tr");
      const w = parseFloat(row.querySelector(".width").value) || 0;
      const h = parseFloat(row.querySelector(".height").value) || 0;
      const d = parseFloat(row.querySelector(".depth").value) || 0;
      const area = d ? (w * h * d) : (w * h);
      row.querySelector(".area").textContent = area.toFixed(3);

      const materialOpt = row.querySelector(".material").selectedOptions[0];
      const price = materialOpt ? parseFloat(materialOpt.dataset.price || 0) : 0;
      row.querySelector(".price").textContent = price.toFixed(2);
      const cost = price * area;
      row.querySelector(".cost").textContent = cost.toFixed(2);

      updateTotal();
    }

    function calcCirc(el) {
      const row = el.closest("tr");
      const d = parseFloat(row.querySelector(".diameter").value) || 0;
      const area = (Math.PI * d * d) / 4;
      row.querySelector(".area").textContent = area.toFixed(3);

      const materialOpt = row.querySelector(".material").selectedOptions[0];
      const price = materialOpt ? parseFloat(materialOpt.dataset.price || 0) : 0;
      row.querySelector(".price").textContent = price.toFixed(2);
      const cost = price * area;
      row.querySelector(".cost").textContent = cost.toFixed(2);

      updateTotal();
    }

    function updateTotal() {
      let total = 0;
      document.querySelectorAll(".cost").forEach(cell => {
        total += parseFloat(cell.textContent) || 0;
      });
      document.getElementById("total-cost").textContent = total.toFixed(2);
    }

    // Theme Toggle
    const themeToggle = document.getElementById("toggle-theme");
    themeToggle.onclick = () => {
      const html = document.documentElement;
      const isDark = html.getAttribute("data-theme") === "dark";
      html.setAttribute("data-theme", isDark ? "light" : "dark");
      localStorage.setItem("theme", isDark ? "light" : "dark");
      document.body.classList.toggle("dark", !isDark);
    };

    // Load saved theme
    window.onload = () => {
      const savedTheme = localStorage.getItem("theme") || "light";
      document.documentElement.setAttribute("data-theme", savedTheme);
      document.body.classList.toggle("dark", savedTheme === "dark");
    };

    // Logout
    document.getElementById("logout").addEventListener("click", () => {
      firebase.auth().signOut().then(() => {
        window.location.href = "login.html";
      });
    });
  </script>
</body>
</html>
