<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Signage Calculator - Calculation</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,700&display=swap" />
  <style>
    :root {
      --bg: #ffffff;
      --text: #000000;
    }
    body.dark {
      --bg: #1e1e1e;
      --text: #ffffff;
    }
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background-color: var(--bg);
      color: var(--text);
      transition: background-color 0.3s, color 0.3s;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
      background: #202020;
      color: white;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .nav-links a {
      margin-left: 1rem;
      text-decoration: none;
      color: white;
    }
    .nav-links a:hover {
      text-decoration: underline;
    }
    header h1 {
      margin: 0;
      font-size: 1.2rem;
    }
    .theme-toggle {
      cursor: pointer;
      padding: 0.2rem 0.6rem;
      background-color: #3700b3;
      border: none;
      color: white;
      border-radius: 4px;
    }
    .container {
      padding: 1rem;
      max-width: 1000px;
      margin: auto;
    }
    h2 {
      margin-top: 2rem;
      font-size: 1.1rem;
      border-bottom: 1px solid var(--text);
      padding-bottom: 0.3rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0.5rem;
    }
    th, td {
      border: 1px solid var(--text);
      padding: 0.5rem;
      text-align: center;
    }
    button {
      margin-top: 1rem;
      padding: 0.4rem 1rem;
      background-color: #6200ea;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    select, input[type="number"] {
      width: 100%;
    }
    .totals {
      margin-top: 1rem;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <strong>Signage Calculator</strong>
      <span class="nav-links">
        <a href="index.html">Database</a>
        <a href="calculation.html">Calculation</a>
        <a href="quotation.html">Quotation</a>
      </span>
    </div>
    <div>
      <span id="userEmail" class="auth-status"></span>
      <button onclick="logout()">Logout</button>
      <button class="theme-toggle" id="themeToggle">ðŸŒ—</button>
    </div>
  </header>

  <div class="container">
    <h2>Rectangular Layers</h2>
    <table id="rectTable">
      <thead>
        <tr>
          <th>Length (mm)</th>
          <th>Width (mm)</th>
          <th>Depth (mm)</th>
          <th>Category</th>
          <th>Material</th>
          <th>Area/Volume</th>
          <th>Price (QR)</th>
          <th>Cost (QR)</th>
          <th>Remove</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="addRectRow()">Add Rectangular Layer</button>

    <h2>Circular Layers</h2>
    <table id="circTable">
      <thead>
        <tr>
          <th>Diameter (mm)</th>
          <th>Thickness (mm)</th>
          <th>Category</th>
          <th>Material</th>
          <th>Area</th>
          <th>Price (QR)</th>
          <th>Cost (QR)</th>
          <th>Remove</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="addCircRow()">Add Circular Layer</button>

    <div class="totals">
      <p>Total Rectangular Area (mÂ²): <span id="totalRectM2">0</span></p>
      <p>Total Rectangular Volume (mÂ³): <span id="totalRectM3">0</span></p>
      <p>Total Circular Area (mÂ²): <span id="totalCircArea">0</span></p>
      <p>Total Material Cost (QR): <span id="totalMaterialCost">0</span></p>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDnDI7b-4AZoP3qArZx2ePJx_A4v_gVjQc",
      authDomain: "signagecalculator.firebaseapp.com",
      databaseURL: "https://signagecalculator-default-rtdb.firebaseio.com",
      projectId: "signagecalculator",
      storageBucket: "signagecalculator.appspot.com",
      messagingSenderId: "690172015156",
      appId: "1:690172015156:web:8cb6d0f9d6b0f2a6b37910"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    const materials = {};

    function logout() {
      auth.signOut().then(() => {
        window.location.href = "login.html";
      });
    }

    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById("userEmail").textContent = user.email;
      } else {
        window.location.href = "login.html";
      }
    });

    function loadMaterials() {
      db.ref("materials").once("value").then(snapshot => {
        snapshot.forEach(catSnap => {
          const cat = catSnap.key;
          materials[cat] = {};
          catSnap.forEach(matSnap => {
            const mat = matSnap.val();
            materials[cat][mat.material_name] = {
              price: parseFloat(mat.material_price) || 0,
              code: mat.material_code || "-"
            };
          });
        });
      });
    }

    function fillCategoryDropdown(catSelect, matSelect) {
      catSelect.innerHTML = `<option value="">Select</option>`;
      Object.keys(materials).forEach(cat => {
        catSelect.innerHTML += `<option value="${cat}">${cat}</option>`;
      });
      matSelect.innerHTML = `<option value="">Select</option>`;
    }

    function updateMaterialOptions(select) {
      const row = select.closest("tr");
      const matSelect = row.querySelector(".material");
      const cat = select.value;
      matSelect.innerHTML = `<option value="">Select</option>`;
      if (materials[cat]) {
        Object.keys(materials[cat]).forEach(mat => {
          matSelect.innerHTML += `<option value="${mat}">${mat}</option>`;
        });
      }
      updateCalculations();
    }

    function addRectRow() {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td><input type="number" class="length" /></td>
        <td><input type="number" class="width" /></td>
        <td><input type="number" class="depth" /></td>
        <td><select class="category" onchange="updateMaterialOptions(this)"></select></td>
        <td><select class="material" onchange="updateCalculations()"></select></td>
        <td class="area">0</td>
        <td class="price">0</td>
        <td class="cost">0</td>
        <td><button onclick="removeRow(this)">X</button></td>
      `;
      document.querySelector("#rectTable tbody").appendChild(row);
      fillCategoryDropdown(row.querySelector(".category"), row.querySelector(".material"));
    }

    function addCircRow() {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td><input type="number" class="diameter" /></td>
        <td><input type="number" class="thickness" /></td>
        <td><select class="category" onchange="updateMaterialOptions(this)"></select></td>
        <td><select class="material" onchange="updateCalculations()"></select></td>
        <td class="area">0</td>
        <td class="price">0</td>
        <td class="cost">0</td>
        <td><button onclick="removeRow(this)">X</button></td>
      `;
      document.querySelector("#circTable tbody").appendChild(row);
      fillCategoryDropdown(row.querySelector(".category"), row.querySelector(".material"));
    }

    function removeRow(btn) {
      btn.closest("tr").remove();
      updateCalculations();
    }

    function updateCalculations() {
      let totalRectM2 = 0, totalRectM3 = 0, totalCircArea = 0, totalCost = 0;

      document.querySelectorAll("#rectTable tbody tr").forEach(row => {
        const l = parseFloat(row.querySelector(".length").value) || 0;
        const w = parseFloat(row.querySelector(".width").value) || 0;
        const d = parseFloat(row.querySelector(".depth").value) || 0;
        const cat = row.querySelector(".category").value;
        const mat = row.querySelector(".material").value;
        const matData = materials[cat]?.[mat] || { price: 0 };

        const area = (l * w) / 1e6;
        const volume = (l * w * d) / 1e9;
        const usedVal = d > 0 ? volume : area;
        const cost = matData.price * usedVal;

        row.querySelector(".area").textContent = usedVal.toFixed(3);
        row.querySelector(".price").textContent = matData.price.toFixed(2);
        row.querySelector(".cost").textContent = cost.toFixed(2);

        totalRectM2 += d === 0 ? area : 0;
        totalRectM3 += d > 0 ? volume : 0;
        totalCost += cost;
      });

      document.querySelectorAll("#circTable tbody tr").forEach(row => {
        const dia = parseFloat(row.querySelector(".diameter").value) || 0;
        const thick = parseFloat(row.querySelector(".thickness").value) || 0;
        const cat = row.querySelector(".category").value;
        const mat = row.querySelector(".material").value;
        const matData = materials[cat]?.[mat] || { price: 0 };

        const radius = dia / 2000;
        const area = Math.PI * radius * radius;
        const volume = area * (thick / 1000);
        const usedVal = thick > 0 ? volume : area;
        const cost = matData.price * usedVal;

        row.querySelector(".area").textContent = usedVal.toFixed(3);
        row.querySelector(".price").textContent = matData.price.toFixed(2);
        row.querySelector(".cost").textContent = cost.toFixed(2);

        totalCircArea += thick === 0 ? area : 0;
        totalCost += cost;
      });

      document.getElementById("totalRectM2").textContent = totalRectM2.toFixed(3);
      document.getElementById("totalRectM3").textContent = totalRectM3.toFixed(3);
      document.getElementById("totalCircArea").textContent = totalCircArea.toFixed(3);
      document.getElementById("totalMaterialCost").textContent = totalCost.toFixed(2);
    }

    document.getElementById("themeToggle").addEventListener("click", () => {
      document.body.classList.toggle("dark");
      localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light");
    });

    window.onload = () => {
      if (localStorage.getItem("theme") === "dark") {
        document.body.classList.add("dark");
      }
      loadMaterials();
    };
  </script>
</body>
</html>
