<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Signage Calculator - Database</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap">
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--fg);
    }
    :root[data-theme='dark'] {
      --bg: #121212;
      --fg: #fff;
      --primary: #3498db;
      --accent: #2ecc71;
      --card: #1f1f1f;
    }
    :root[data-theme='light'] {
      --bg: #f4f4f4;
      --fg: #000;
      --primary: #2980b9;
      --accent: #27ae60;
      --card: #fff;
    }
    nav {
      background: var(--card);
      padding: 1rem 2rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #ccc;
    }
    nav .left { font-size: 1.5rem; font-weight: bold; }
    nav .right {
      display: flex;
      gap: 1.5rem;
      align-items: center;
    }
    nav a {
      color: var(--fg);
      text-decoration: none;
      font-weight: 500;
    }
    nav a:hover {
      color: var(--accent);
    }
    .theme-toggle, .logout-btn {
      cursor: pointer;
      background: none;
      border: none;
      color: var(--fg);
      font-size: 1rem;
    }

    .tabs {
      display: flex; flex-wrap: wrap;
      gap: 10px;
      padding: 1rem 2rem;
    }
    .tab {
      background: var(--card);
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
    }
    .tab.active {
      background: var(--primary);
      color: white;
    }
    .add-cat {
      background: var(--accent);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
    }

    .table-container {
      margin: 0 2rem 2rem;
      background: var(--card);
      border-radius: 8px;
      overflow: hidden;
    }
    .table-scroll {
      max-height: 400px;
      overflow-y: auto;
    }
    .header-row, .filter-row, .data-row {
      display: flex;
    }
    .header-row div, .filter-row div, .data-row div {
      padding: 8px;
      border-bottom: 1px solid #ccc;
      min-width: 140px;
      flex-shrink: 0;
    }
    .filter-row input {
      width: 100%;
      padding: 4px;
    }
    .action-btn {
      background: none;
      border: none;
      color: var(--primary);
      cursor: pointer;
    }
    .action-btn:hover {
      text-decoration: underline;
    }
    .highlight {
      background: #fffa9e;
    }
  </style>
</head>
<body>
  <nav>
    <div class="left">Signage Calculator</div>
    <div class="right">
      <a href="index.html">Database</a>
      <a href="calculation.html">Calculation</a>
      <a href="quotation.html">Quotation â–¼</a>
      <span id="user-email"></span>
      <button class="logout-btn" onclick="logout()">Logout</button>
      <button class="theme-toggle" onclick="toggleTheme()">ðŸŒ™</button>
    </div>
  </nav>

  <div class="tabs" id="tabs"></div>
  <div id="tables"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import {
      getDatabase, ref, onValue, push, set, update, remove
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import {
      getAuth, onAuthStateChanged, signOut
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCXtiSnNBHs1NQXwL6vrK-U71veeMpIpXQ",
      authDomain: "signagematerialdatabaseapp.firebaseapp.com",
      databaseURL: "https://signagematerialdatabaseapp-default-rtdb.firebaseio.com",
      projectId: "signagematerialdatabaseapp",
      storageBucket: "signagematerialdatabaseapp.firebasestorage.app",
      messagingSenderId: "276886100857",
      appId: "1:276886100857:web:ec1b93f74995aa30e1ada8",
      measurementId: "G-R4EHYT0MW6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const userEmail = document.getElementById("user-email");

    const headers = ["Material Code", "Material Name", "Material Price", "Unit", "Price per Unit", "Unit2"];
    let userRole = "user";

    function logout() {
      signOut(auth).then(() => location.href = "login.html");
    }

    function toggleTheme() {
      const html = document.documentElement;
      html.dataset.theme = html.dataset.theme === "dark" ? "light" : "dark";
    }

    onAuthStateChanged(auth, user => {
      if (!user) {
        location.href = "login.html";
      } else {
        userEmail.textContent = "Logged in as: " + user.email;
        if (user.email === "admin@email.com") userRole = "admin";
        loadTabs();
      }
    });

    function loadTabs() {
      const tabWrap = document.getElementById("tabs");
      const tablesWrap = document.getElementById("tables");

      onValue(ref(db), snapshot => {
        const data = snapshot.val();
        tabWrap.innerHTML = "";
        tablesWrap.innerHTML = "";

        if (!data) return;

        const categories = Object.keys(data);
        categories.forEach((cat, idx) => {
          const tab = document.createElement("div");
          tab.className = "tab" + (idx === 0 ? " active" : "");
          tab.textContent = cat;
          tab.onclick = () => showCategory(cat);
          tabWrap.appendChild(tab);

          const tableWrap = document.createElement("div");
          tableWrap.id = `table-${cat}`;
          tableWrap.className = "table-container" + (idx === 0 ? "" : " hidden");

          const header = document.createElement("div");
          header.className = "header-row";
          headers.forEach(h => {
            const col = document.createElement("div");
            col.textContent = h;
            header.appendChild(col);
          });
          if (userRole === "admin") header.appendChild(document.createElement("div")).textContent = "Action";

          const filterRow = document.createElement("div");
          filterRow.className = "filter-row";
          headers.forEach((_, i) => {
            const cell = document.createElement("div");
            const input = document.createElement("input");
            input.placeholder = "Filter...";
            input.oninput = () => filterRows(cat, i, input.value);
            cell.appendChild(input);
            filterRow.appendChild(cell);
          });
          if (userRole === "admin") filterRow.appendChild(document.createElement("div"));

          const scrollWrap = document.createElement("div");
          scrollWrap.className = "table-scroll";

          const rows = document.createElement("div");
          rows.className = "data-rows";
          const materials = data[cat];
          for (let key in materials) {
            const rowData = materials[key];
            rows.appendChild(createRow(cat, key, rowData));
          }

          scrollWrap.appendChild(rows);
          tableWrap.appendChild(filterRow);
          tableWrap.appendChild(header);
          tableWrap.appendChild(scrollWrap);

          if (userRole === "admin") {
            const btn = document.createElement("button");
            btn.textContent = "+ Add Material";
            btn.className = "add-cat";
            btn.onclick = () => {
              const newRef = push(ref(db, cat));
              const blank = {};
              headers.forEach(h => blank[h] = "");
              set(newRef, blank);
            };
            tableWrap.appendChild(btn);
          }

          tablesWrap.appendChild(tableWrap);
        });

        if (userRole === "admin") {
          const addCategoryBtn = document.createElement("button");
          addCategoryBtn.textContent = "+ Add Category";
          addCategoryBtn.className = "add-cat";
          addCategoryBtn.onclick = () => {
            const name = prompt("New category name?");
            if (name) set(ref(db, name), {});
          };
          tabWrap.appendChild(addCategoryBtn);
        }
      });
    }

    function showCategory(cat) {
      document.querySelectorAll(".table-container").forEach(e => e.classList.add("hidden"));
      document.querySelector(`#table-${cat}`).classList.remove("hidden");
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      [...document.querySelectorAll(".tab")].find(t => t.textContent === cat)?.classList.add("active");
    }

    function createRow(cat, key, rowData) {
      const row = document.createElement("div");
      row.className = "data-row";
      const cells = [];

      headers.forEach(h => {
        const div = document.createElement("div");
        div.textContent = rowData[h] || "";
        div.contentEditable = false;
        row.appendChild(div);
        cells.push(div);
      });

      if (userRole === "admin") {
        const action = document.createElement("div");
        const edit = document.createElement("button");
        edit.textContent = "Edit";
        edit.className = "action-btn";
        edit.onclick = () => {
          const editing = edit.textContent === "Edit";
          cells.forEach(c => {
            c.contentEditable = editing;
            c.classList.toggle("highlight", editing);
          });
          edit.textContent = editing ? "Save" : "Edit";
          if (!editing) {
            const updated = {};
            headers.forEach((h, i) => updated[h] = cells[i].textContent.trim());
            update(ref(db, `${cat}/${key}`), updated);
          }
        };

        const del = document.createElement("button");
        del.textContent = "Delete";
        del.className = "action-btn";
        del.onclick = () => {
          if (confirm("Delete this material?")) {
            remove(ref(db, `${cat}/${key}`));
          }
        };

        action.appendChild(edit);
        action.appendChild(del);
        row.appendChild(action);
      }

      return row;
    }

    function filterRows(cat, index, value) {
      const table = document.getElementById(`table-${cat}`);
      const rows = table.querySelectorAll(".data-row");
      rows.forEach(r => {
        const cell = r.children[index];
        r.style.display = cell.textContent.toLowerCase().includes(value.toLowerCase()) ? "" : "none";
      });
    }
  </script>
</body>
</html>
