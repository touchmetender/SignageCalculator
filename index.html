<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Signage Calculator â€“ Material Database</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body.dark { background: #121212; color: white; }
    body.light { background: #f4f4f4; color: black; }
    header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 1rem 2rem; background: #202020; color: white;
      position: sticky; top: 0; z-index: 100;
    }
    .nav-links a {
      margin-left: 1rem; text-decoration: none; color: white;
    }
    .nav-links a:hover { text-decoration: underline; }
    .mode-toggle, .auth-status { margin-left: 1rem; cursor: pointer; }
    .table-container {
      max-height: 70vh; overflow-y: auto; border: 1px solid #ccc; margin: 1rem;
    }
    table { width: 100%; border-collapse: collapse; }
    thead th { background: #333; color: white; position: sticky; top: 0; }
    td, th { padding: 0.5rem; border: 1px solid #ddd; }
    tr.editing { background: #fffae6; }
    .actions button { margin: 0 2px; }
    .filter-row input { width: 100%; padding: 2px; }
  </style>
</head>
<body class="dark">
  <header>
    <div>
      <strong>Signage Calculator</strong>
      <span class="nav-links">
        <a href="index.html">Database</a>
        <a href="calculation.html">Calculation</a>
        <a href="quotation.html">Quotation</a>
        <a href="#">More â–¼</a>
      </span>
    </div>
    <div>
      <span id="userEmail" class="auth-status"></span>
      <button onclick="logout()">Logout</button>
      <button class="mode-toggle" onclick="toggleMode()">ðŸŒ—</button>
    </div>
  </header>

  <main>
    <div style="padding: 1rem;">
      <h2>Material Database</h2>
      <button onclick="addCategory()">+ Add Category</button>
    </div>
    <div class="table-container" id="materialTableContainer"></div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, onValue, set, push, remove, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCXtiSnNBHs1NQXwL6vrK-U71veeMpIpXQ",
      authDomain: "signagematerialdatabaseapp.firebaseapp.com",
      databaseURL: "https://signagematerialdatabaseapp-default-rtdb.firebaseio.com",
      projectId: "signagematerialdatabaseapp",
      storageBucket: "signagematerialdatabaseapp.appspot.com",
      messagingSenderId: "276886100857",
      appId: "1:276886100857:web:ec1b93f74995aa30e1ada8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const dbRef = ref(db, 'materials');
    let isAdmin = false;
    let currentUser = null;

    const tableContainer = document.getElementById("materialTableContainer");

    onAuthStateChanged(auth, (user) => {
      if (!user) return location.href = "login.html";
      currentUser = user;
      document.getElementById("userEmail").textContent = `Logged in as: ${user.email}`;
      isAdmin = (user.email === "YOUR_ADMIN_EMAIL@example.com"); // REPLACE with your admin email
      loadData();
    });

    function logout() {
      signOut(auth).then(() => location.href = "login.html");
    }

    function toggleMode() {
      document.body.classList.toggle("dark");
      document.body.classList.toggle("light");
    }

    function loadData() {
      onValue(dbRef, snapshot => {
        const data = snapshot.val() || {};
        renderTable(data);
      });
    }

    function renderTable(data) {
      tableContainer.innerHTML = '';
      Object.keys(data).forEach(category => {
        const categoryDiv = document.createElement('div');
        const title = document.createElement('h3');
        title.textContent = category + (isAdmin ? ` ` : '');
        if (isAdmin) {
          const delBtn = document.createElement("button");
          delBtn.textContent = "Delete Category";
          delBtn.onclick = () => remove(ref(db, `materials/${category}`));
          title.appendChild(delBtn);
        }
        categoryDiv.appendChild(title);

        const table = document.createElement('table');
        const thead = document.createElement('thead');
        thead.innerHTML = `
          <tr><th>Code</th><th>Name</th><th>Price</th><th>Unit</th><th>Price/Unit</th><th>Unit 2</th>${isAdmin ? '<th>Actions</th>' : ''}</tr>
          <tr class="filter-row"><th><input></th><th><input></th><th><input></th><th><input></th><th><input></th><th><input></th>${isAdmin ? '<th></th>' : ''}</tr>
        `;
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        Object.entries(data[category]).forEach(([key, item]) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${item.code}</td>
            <td>${item.name}</td>
            <td>${item.price}</td>
            <td>${item.unit}</td>
            <td>${item.price_per_unit}</td>
            <td>${item.unit2}</td>
            ${isAdmin ? `<td class="actions">
              <button onclick="editRow('${category}', '${key}', this)">Edit</button>
              <button onclick="deleteMaterial('${category}', '${key}')">Delete</button>
            </td>` : ''}
          `;
          tbody.appendChild(row);
        });

        if (isAdmin) {
          const addRow = document.createElement("tr");
          addRow.innerHTML = `
            <td><input id="code"></td>
            <td><input id="name"></td>
            <td><input id="price"></td>
            <td><input id="unit"></td>
            <td><input id="ppu"></td>
            <td><input id="unit2"></td>
            <td><button onclick="addMaterial('${category}')">Add Material</button></td>
          `;
          tbody.appendChild(addRow);
        }

        table.appendChild(tbody);
        categoryDiv.appendChild(table);
        tableContainer.appendChild(categoryDiv);
      });
    }

    window.editRow = function (cat, key, btn) {
      const row = btn.closest('tr');
      row.classList.add("editing");
      const tds = row.querySelectorAll("td");
      const values = Array.from(tds).slice(0, 6).map(td => td.textContent);
      row.innerHTML = values.map(val => `<td><input value="${val}"></td>`).join("") +
        `<td><button onclick="saveRow('${cat}', '${key}', this)">Save</button></td>`;
    }

    window.saveRow = function (cat, key, btn) {
      const row = btn.closest('tr');
      const inputs = row.querySelectorAll("input");
      const [code, name, price, unit, ppu, unit2] = Array.from(inputs).map(i => i.value);
      update(ref(db, `materials/${cat}/${key}`), {
        code, name, price, unit, price_per_unit: ppu, unit2
      });
    }

    window.deleteMaterial = function (cat, key) {
      remove(ref(db, `materials/${cat}/${key}`));
    }

    window.addCategory = function () {
      const newCat = prompt("Enter new category name:");
      if (newCat) {
        set(ref(db, `materials/${newCat}`), {});
      }
    }

    window.addMaterial = function (cat) {
      const code = document.getElementById("code").value;
      const name = document.getElementById("name").value;
      const price = document.getElementById("price").value;
      const unit = document.getElementById("unit").value;
      const ppu = document.getElementById("ppu").value;
      const unit2 = document.getElementById("unit2").value;
      const newRef = push(ref(db, `materials/${cat}`));
      set(newRef, { code, name, price, unit, price_per_unit: ppu, unit2 });
    }
  </script>
</body>
</html>
