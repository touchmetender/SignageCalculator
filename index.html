<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Material Database</title>
  <style>
    body { font-family: sans-serif; margin: 0; }
    header { background: #333; color: white; padding: 10px; display: flex; justify-content: space-between; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 5px; }
    th { background: #eee; position: sticky; top: 0; z-index: 1; }
    tbody { display: block; max-height: 400px; overflow-y: auto; }
    thead, tbody tr { display: table; width: 100%; table-layout: fixed; }
    .admin-controls { margin: 10px; }
  </style>
</head>
<body>
  <header>
    <div>Signage Calculator - Materials</div>
    <div id="auth-status">Logged in as: <span id="user-email"></span> | <button onclick="logout()">Logout</button></div>
  </header>
  
  <div class="admin-controls" id="admin-actions" style="display: none;">
    <button onclick="addCategory()">Add Category</button>
    <button onclick="addMaterial()">Add Material</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Code</th><th>Name</th><th>Price</th><th>Unit</th><th>Per Unit</th><th>Unit 2</th><th>Action</th>
      </tr>
    </thead>
    <tbody id="material-body"></tbody>
  </table>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="firebase.js"></script>
  <script>
    const adminEmail = "admin@example.com";
    let currentUser;

    firebase.auth().onAuthStateChanged(user => {
      if (!user) return window.location.href = "login.html";
      currentUser = user;
      document.getElementById("user-email").textContent = user.email;
      if (user.email === adminEmail) {
        document.getElementById("admin-actions").style.display = "block";
      }
      loadMaterials();
    });

    function logout() {
      firebase.auth().signOut().then(() => window.location.href = "login.html");
    }

    function loadMaterials() {
      const ref = firebase.database().ref("materials");
      ref.on("value", snapshot => {
        const tbody = document.getElementById("material-body");
        tbody.innerHTML = "";
        snapshot.forEach(cat => {
          cat.forEach(mat => {
            const m = mat.val();
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${m.code}</td><td>${m.name}</td><td>${m.price}</td><td>${m.unit}</td>
              <td>${m.perUnit}</td><td>${m.unit2}</td>
              <td>${currentUser.email === adminEmail ? `<button onclick="editMaterial('${cat.key}','${mat.key}')">Edit</button>` : ''}</td>
            `;
            tbody.appendChild(row);
          });
        });
      });
    }

    function addCategory() {
      const name = prompt("New Category:");
      if (name) firebase.database().ref("materials/" + name).set({});
    }

    function addMaterial() {
      const category = prompt("Enter Category:");
      const data = {
        code: prompt("Code:"),
        name: prompt("Name:"),
        price: prompt("Price:"),
        unit: prompt("Unit:"),
        perUnit: prompt("Per Unit:"),
        unit2: prompt("Unit 2:")
      };
      firebase.database().ref(`materials/${category}`).push(data);
    }

    function editMaterial(cat, key) {
      const ref = firebase.database().ref(`materials/${cat}/${key}`);
      ref.once("value", snap => {
        const m = snap.val();
        const updated = {
          code: prompt("Code:", m.code),
          name: prompt("Name:", m.name),
          price: prompt("Price:", m.price),
          unit: prompt("Unit:", m.unit),
          perUnit: prompt("Per Unit:", m.perUnit),
          unit2: prompt("Unit 2:", m.unit2)
        };
        ref.set(updated);
      });
    }
  </script>
</body>
</html>
