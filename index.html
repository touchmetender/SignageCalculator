<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Material Database - Signage Calculator</title>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js"></script>
  <script src="firebase.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; }
    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    #user-info { font-size: 14px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    tbody { display: block; height: 400px; overflow-y: auto; }
    thead, tbody tr { display: table; width: 100%; table-layout: fixed; }
    .edit-row { background-color: #ffffcc; }
  </style>
</head>
<body>
  <header>
    <div><b>Material Database</b></div>
    <div id="user-info">Logged in as: <span id="user-email"></span> | <button onclick="logout()">Logout</button></div>
  </header>
  <div><a href="calculation.html">Go to Calculator</a></div>
  <table>
    <thead>
      <tr><th>Code</th><th>Name</th><th>Price</th><th>Unit</th><th>Per Unit</th><th>Unit</th><th>Action</th></tr>
    </thead>
    <tbody id="material-table"></tbody>
  </table>

  <script>
    const db = firebase.database();
    let currentUser = null;

    firebase.auth().onAuthStateChanged(user => {
      if (!user) return window.location.href = "login.html";
      currentUser = user;
      document.getElementById('user-email').textContent = user.email;
      loadMaterials();
    });

    function loadMaterials() {
      db.ref('materials').on('value', snapshot => {
        const tbody = document.getElementById("material-table");
        tbody.innerHTML = "";
        snapshot.forEach(cat => {
          cat.forEach(item => {
            const val = item.val();
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${item.key}</td>
              <td>${val.name}</td>
              <td contenteditable="${isAdmin()}">${val.price}</td>
              <td>${val.unit}</td>
              <td contenteditable="${isAdmin()}">${val.pricePerUnit}</td>
              <td>${val.perUnit}</td>
              <td>${isAdmin() ? `<button onclick="save('${cat.key}','${item.key}', this)">Save</button>` : ''}</td>
            `;
            tbody.appendChild(tr);
          });
        });
      });
    }

    function save(cat, key, btn) {
      const row = btn.parentElement.parentElement;
      const price = row.cells[2].textContent;
      const pricePerUnit = row.cells[4].textContent;
      db.ref(`materials/${cat}/${key}`).update({ price: parseFloat(price), pricePerUnit: parseFloat(pricePerUnit) });
      row.classList.remove("edit-row");
    }

    function isAdmin() {
      return currentUser.email === 'your-admin-email@example.com';
    }

    function logout() {
      firebase.auth().signOut().then(() => window.location.href = "login.html");
    }
  </script>
</body>
</html>
