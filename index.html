<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Signage Calculator - Database</title>
  <style>
    body.dark { background: #1e1e1e; color: white; }
    body.light { background: #f8f8f8; color: black; }
    body { margin: 0; font-family: Arial, sans-serif; }

    .navbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #333;
      color: white;
      padding: 10px 20px;
    }
    .navbar .left { font-weight: bold; font-size: 18px; }
    .navbar .right button {
      margin-left: 10px; padding: 5px 10px; cursor: pointer;
    }
    .tabs { display: flex; gap: 10px; padding: 10px; flex-wrap: wrap; }
    .tab, .add-cat-btn {
      padding: 10px 20px;
      background: #ddd; border-radius: 5px; cursor: pointer;
    }
    .tab.active { background: #3498db; color: white; }
    .add-cat-btn { background: #2ecc71; color: white; border: none; }

    .table-wrapper {
      padding: 10px; margin: 10px;
      background: white; border-radius: 8px; overflow-x: auto;
    }
    .table-wrapper.dark { background: #2e2e2e; }

    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td {
      border: 1px solid #ccc; padding: 6px; text-align: left;
    }
    th.sticky { position: sticky; top: 0; background: #f0f0f0; z-index: 1; }
    .dark th.sticky { background: #3a3a3a; }

    .action-btn { cursor: pointer; color: #007bff; background: none; border: none; }
    .action-btn:hover { text-decoration: underline; }

    .add-material-row input {
      width: 100%; padding: 4px;
    }

    .hidden { display: none; }
  </style>
</head>
<body class="dark">
  <div class="navbar">
    <div class="left">Signage Calculator</div>
    <div class="right">
      <span id="user-info"></span>
      <button onclick="toggleTheme()">Toggle Mode</button>
      <button onclick="location.href='calculation.html'">Calculation</button>
      <button onclick="location.href='quotation.html'">Quotation</button>
      <button onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="tabs" id="tabs"></div>
  <div id="tables"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, onValue, set, remove, push, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCXtiSnNBHs1NQXwL6vrK-U71veeMpIpXQ",
      authDomain: "signagematerialdatabaseapp.firebaseapp.com",
      databaseURL: "https://signagematerialdatabaseapp-default-rtdb.firebaseio.com",
      projectId: "signagematerialdatabaseapp",
      storageBucket: "signagematerialdatabaseapp.firebasestorage.app",
      messagingSenderId: "276886100857",
      appId: "1:276886100857:web:ec1b93f74995aa30e1ada8",
      measurementId: "G-R4EHYT0MW6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    let currentUser = null;
    let isAdmin = false;

    const tablesDiv = document.getElementById("tables");
    const tabs = document.getElementById("tabs");

    function toggleTheme() {
      document.body.classList.toggle("dark");
      document.body.classList.toggle("light");
    }

    function logout() {
      signOut(auth).then(() => {
        location.href = "login.html";
      });
    }

    function buildUI(data) {
      tabs.innerHTML = '';
      tablesDiv.innerHTML = '';
      for (let category in data) {
        const tab = document.createElement("div");
        tab.className = "tab";
        tab.textContent = category;
        tab.onclick = () => {
          document.querySelectorAll(".table-wrapper").forEach(w => w.classList.add("hidden"));
          document.getElementById(`tbl-${category}`).classList.remove("hidden");
          document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
          tab.classList.add("active");
        };
        tabs.appendChild(tab);

        const tableWrapper = document.createElement("div");
        tableWrapper.className = "table-wrapper";
        tableWrapper.id = `tbl-${category}`;

        const table = document.createElement("table");
        const thead = document.createElement("thead");
        const headerRow = document.createElement("tr");
        const filterRow = document.createElement("tr");

        const cols = ["material_code", "material_name", "material_price", "unit", "price_per_unit", "unit2"];
        cols.forEach(col => {
          const th = document.createElement("th");
          th.className = "sticky";
          th.textContent = col.replace(/_/g, " ");
          headerRow.appendChild(th);

          const filter = document.createElement("th");
          const input = document.createElement("input");
          input.oninput = () => filterTable(category, cols.indexOf(col), input.value);
          filter.appendChild(input);
          filterRow.appendChild(filter);
        });

        if (isAdmin) {
          const th = document.createElement("th");
          th.className = "sticky";
          th.textContent = "Actions";
          headerRow.appendChild(th);
          filterRow.appendChild(document.createElement("th"));
        }

        thead.appendChild(filterRow);
        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        const catData = data[category];
        for (let key in catData) {
          tbody.appendChild(buildRow(catData[key], category, key));
        }

        if (isAdmin) {
          const addRow = document.createElement("tr");
          addRow.className = "add-material-row";
          cols.forEach(c => {
            const td = document.createElement("td");
            const input = document.createElement("input");
            input.placeholder = c;
            td.appendChild(input);
            addRow.appendChild(td);
          });

          const tdAction = document.createElement("td");
          const btn = document.createElement("button");
          btn.textContent = "Add";
          btn.onclick = () => {
            const newData = {};
            const inputs = addRow.querySelectorAll("input");
            cols.forEach((c, i) => newData[c] = inputs[i].value.trim());
            push(ref(db, category), newData);
            inputs.forEach(i => i.value = "");
          };
          tdAction.appendChild(btn);
          addRow.appendChild(tdAction);
          tbody.appendChild(addRow);
        }

        table.appendChild(tbody);
        tableWrapper.appendChild(table);
        tablesDiv.appendChild(tableWrapper);
      }

      document.querySelector(".tab")?.click();
    }

    function buildRow(data, category, key) {
      const tr = document.createElement("tr");
      const cols = ["material_code", "material_name", "material_price", "unit", "price_per_unit", "unit2"];
      const tds = [];

      cols.forEach(c => {
        const td = document.createElement("td");
        td.textContent = data[c] || "";
        td.contentEditable = false;
        tr.appendChild(td);
        tds.push(td);
      });

      if (isAdmin) {
        const tdAction = document.createElement("td");
        const editBtn = document.createElement("button");
        editBtn.textContent = "Edit";
        editBtn.className = "action-btn";
        editBtn.onclick = () => {
          const editing = editBtn.textContent === "Edit";
          tds.forEach(td => {
            td.contentEditable = editing;
            td.style.background = editing ? "#ffe" : "";
          });
          if (editing) {
            editBtn.textContent = "Save";
          } else {
            editBtn.textContent = "Edit";
            const updated = {};
            cols.forEach((c, i) => updated[c] = tds[i].textContent.trim());
            update(ref(db, `${category}/${key}`), updated);
          }
        };

        const delBtn = document.createElement("button");
        delBtn.textContent = "Delete";
        delBtn.className = "action-btn";
        delBtn.onclick = () => {
          if (confirm("Delete this item?")) {
            remove(ref(db, `${category}/${key}`));
          }
        };

        tdAction.appendChild(editBtn);
        tdAction.appendChild(document.createTextNode(" "));
        tdAction.appendChild(delBtn);
        tr.appendChild(tdAction);
      }

      return tr;
    }

    function filterTable(category, index, value) {
      const rows = document.querySelectorAll(`#tbl-${category} tbody tr`);
      rows.forEach(row => {
        const cells = row.querySelectorAll("td");
        if (!cells[index]) return;
        const match = cells[index].textContent.toLowerCase().includes(value.toLowerCase());
        row.style.display = match ? "" : "none";
      });
    }

    onAuthStateChanged(auth, user => {
      if (!user) return location.href = "login.html";
      currentUser = user;
      document.getElementById("user-info").textContent = `Logged in as: ${user.email}`;
      isAdmin = user.email === "admin@example.com"; // Set your real admin email
      onValue(ref(db), snapshot => {
        const data = snapshot.val();
        if (data) buildUI(data);
      });
    });
  </script>
</body>
</html>
